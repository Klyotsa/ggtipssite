RewriteEngine On
RewriteBase /
RewriteRule ^index\.html$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule . /index.html [L]

# CORS Headers
<IfModule mod_headers.c>
  Header set Access-Control-Allow-Origin "*"
  Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
  Header set Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type"
</IfModule>

# Кеширование статических ресурсов
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType application/pdf "access plus 1 month"
  ExpiresByType video/mp4 "access plus 1 year"
  ExpiresByType video/webm "access plus 1 year"
  ExpiresByType audio/mp3 "access plus 1 year"
  ExpiresByType audio/ogg "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType application/x-javascript "access plus 1 month"
  ExpiresByType application/x-shockwave-flash "access plus 1 month"
  ExpiresDefault "access plus 2 days"
</IfModule>

# Включение сжатия
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Корректная обработка медиа файлов
<IfModule mod_mime.c>
  AddType image/svg+xml .svg .svgz
  AddEncoding gzip .svgz
  AddType video/mp4 .mp4 .m4v
  AddType video/webm .webm
  AddType video/ogg .ogv
  AddType audio/mp4 .m4a
  AddType audio/mp3 .mp3
  AddType audio/ogg .ogg .oga
  AddType video/x-flv .flv
  AddType application/x-shockwave-flash .swf
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType application/vnd.ms-fontobject .eot
  AddType font/ttf .ttf
  AddType font/otf .otf
</IfModule>

# Установка кодировки по умолчанию
AddDefaultCharset UTF-8

# Заголовки безопасности
<IfModule mod_headers.c>
  Header set X-Content-Type-Options "nosniff"
  Header set X-XSS-Protection "1; mode=block"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
  Header set Referrer-Policy "no-referrer-when-downgrade"
  Header set Permissions-Policy "geolocation=(self), microphone=()"
  
  # Правильное кэширование для файлов с хэшем в имени
  <FilesMatch "\.(js|css|jpg|jpeg|png|gif|webp|ico|svg|mp4|webm|woff|woff2)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
  </FilesMatch>
</IfModule>

# DirectoryIndex
DirectoryIndex index.html

# Prevent directory listing
Options -Indexes

# Prevent mod_dir appending slash to directories
DirectorySlash Off

# Защита важных файлов
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
  Order allow,deny
  Deny from all
  Satisfy All
</FilesMatch>

# Защита от хотлинкинга с настройкой для корректной работы сайта
<IfModule mod_rewrite.c>
  RewriteCond %{HTTP_REFERER} !^$
  RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
  RewriteCond %{HTTP_REFERER} !^https?://(www\.)?localhost [NC]
  RewriteCond %{REQUEST_URI} \.(jpg|jpeg|png|gif|webp|mp4|webm)$ [NC]
  # Раскомментируйте следующую строку, чтобы заблокировать доступ
  # RewriteRule \.(jpg|jpeg|png|gif|webp|mp4|webm)$ - [F]
</IfModule>

# Поддержка HTTP/2 push (если сервер поддерживает)
<IfModule mod_headers.c>
  <FilesMatch "index\.html">
    Header add Link "</assets/js/vendor-[hash].js>;rel=preload;as=script"
    Header add Link "</assets/js/main-[hash].js>;rel=preload;as=script"
    Header add Link "</assets/css/main-[hash].css>;rel=preload;as=style"
  </FilesMatch>
</IfModule> 